<?xml version="1.0"?>

<project default="prepare-working-dir" xmlns:if="ant:if" xmlns:unless="ant:unless">
	<property file="working.dir.${user.name}.properties" />
	<property file="working.dir.${env.COMPUTERNAME}.properties" />
	<property file="working.dir.${env.HOST}.properties" />
	<property file="working.dir.${env.HOSTNAME}.properties" />
	<property file="working.dir.properties" />

	<condition property="prepare.working.dir.private">
		<not>
			<available file="git-commit-portal" />
		</not>
	</condition>

	<macrodef name="checkout-dxp-apps">
		<attribute name="checkout.dxp.apps.branch" />
		<attribute name="checkout.dxp.apps.dirs" />
		<attribute name="checkout.dxp.apps.sha" />
		<attribute name="checkout.dxp.branch.name" />

		<sequential>
			<fetch-portal
				fetch.portal.local.branch.name="git-branch-portal-dxp-apps"
				fetch.portal.remote.branch.name="@{checkout.dxp.apps.branch}"
				fetch.portal.repository.name="liferay-portal-ee"
			/>

			<local name="return.code" />

			<exec executable="git" failonerror="false" resultproperty="return.code">
				<arg value="tag" />
				<arg value="--force" />
				<arg value="git-tag-portal-dxp-apps" />
				<arg value="@{checkout.dxp.apps.sha}" />
			</exec>

			<exec executable="git">
				<arg value="branch" />
				<arg value="--delete" />
				<arg value="--force" />
				<arg value="git-branch-portal-dxp-apps" />
			</exec>

			<fail message="Please fetch the DXP branch from upstream before using this command.">
				<condition>
					<not>
						<equals arg1="${return.code}" arg2="0" />
					</not>
				</condition>
			</fail>

			<local name="checkout.dxp.apps.dirs.git" />

			<property name="checkout.dxp.apps.dirs.git" value="@{checkout.dxp.apps.dirs}" />

			<script language="javascript">
				<![CDATA[
					var checkoutDXPAppsDirs = project.getProperty("checkout.dxp.apps.dirs.git");

					project.setProperty("checkout.dxp.apps.dirs.git", checkoutDXPAppsDirs.replace(",", " "));
				]]>
			</script>

			<echo>git checkout refs/tags/git-tag-portal-dxp-apps -- ${checkout.dxp.apps.dirs.git}</echo>

			<exec executable="git" failonerror="true">
				<arg value="checkout" />
				<arg value="refs/tags/git-tag-portal-dxp-apps" />
				<arg value="--" />
				<arg line="${checkout.dxp.apps.dirs.git}" />
			</exec>

			<exec executable="git">
				<arg value="reset" />
				<arg value="HEAD" />
				<arg value="." />
			</exec>

			<exec executable="git">
				<arg value="tag" />
				<arg value="--delete" />
				<arg value="git-tag-portal-dxp-apps" />
			</exec>
		</sequential>
	</macrodef>

	<macrodef name="checkout-subrepository">
		<attribute name="checkout.subrepository.branch" />
		<attribute name="checkout.subrepository.destination" />
		<attribute name="checkout.subrepository.dir" />
		<attribute name="checkout.subrepository.name" />
		<attribute name="checkout.subrepository.sha" />

		<sequential>
			<fetch-subrepository
				fetch.subrepository.dir="@{checkout.subrepository.dir}"
				fetch.subrepository.local.branch.name="git-branch-subrepository"
				fetch.subrepository.name="@{checkout.subrepository.name}"
				fetch.subrepository.remote.branch.name="@{checkout.subrepository.branch}"
			/>

			<local name="return.code" />

			<echo>git -C @{checkout.subrepository.dir} tag --force git-tag-subrepository @{checkout.subrepository.sha}</echo>

			<exec executable="git" failonerror="false" resultproperty="return.code">
				<arg value="-C" />
				<arg value="@{checkout.subrepository.dir}" />
				<arg value="tag" />
				<arg value="--force" />
				<arg value="git-tag-subrepository" />
				<arg value="@{checkout.subrepository.sha}" />
			</exec>

			<exec executable="git">
				<arg value="-C" />
				<arg value="@{checkout.subrepository.dir}" />
				<arg value="branch" />
				<arg value="--delete" />
				<arg value="--force" />
				<arg value="git-branch-subrepository" />
			</exec>

			<fail message="Please fetch the subrepository from upstream before using this command.">
				<condition>
					<not>
						<equals arg1="${return.code}" arg2="0" />
					</not>
				</condition>
			</fail>

			<delete dir="@{checkout.subrepository.destination}" />

			<echo>git clone --shared --branch git-tag-subrepository @{checkout.subrepository.dir} @{checkout.subrepository.destination}</echo>

			<exec executable="git" failonerror="true">
				<arg value="clone" />
				<arg value="--shared" />
				<arg value="--branch" />
				<arg value="git-tag-subrepository" />
				<arg value="@{checkout.subrepository.dir}" />
				<arg value="@{checkout.subrepository.destination}" />
			</exec>

			<delete dir="@{checkout.subrepository.destination}/.git" />
			<delete dir="@{checkout.subrepository.destination}/gradle" />
			<delete file="@{checkout.subrepository.destination}/gradlew" />
			<delete file="@{checkout.subrepository.destination}/gradlew.bat" />

			<exec executable="git">
				<arg value="-C" />
				<arg value="@{checkout.subrepository.dir}" />
				<arg value="tag" />
				<arg value="--delete" />
				<arg value="git-tag-subrepository" />
			</exec>
		</sequential>
	</macrodef>

	<macrodef name="fetch-portal">
		<attribute name="fetch.portal.local.branch.name" />
		<attribute name="fetch.portal.remote.branch.name" />
		<attribute name="fetch.portal.repository.name" />

		<sequential>
			<local name="fetch.portal.repository.url" />

			<condition else="git@github.com:liferay/@{fetch.portal.repository.name}.git" property="fetch.portal.repository.url" value="git@github-dev.liferay.com:liferay/@{fetch.portal.repository.name}.git">
				<isset property="env.JENKINS_HOME" />
			</condition>

			<local name="fetch.portal.branch.name" />

			<condition else="@{fetch.portal.remote.branch.name}" property="fetch.portal.branch.name" value="@{fetch.portal.local.branch.name}">
				<not>
					<equals arg1="${fetch.portal.local.branch.name}" arg2="" />
				</not>
			</condition>

			<echo>git fetch --force --no-tags ${fetch.portal.repository.url} @{fetch.portal.remote.branch.name}:${fetch.portal.branch.name}</echo>

			<exec executable="git">
				<arg value="fetch" />
				<arg value="--force" />
				<arg value="--no-tags" />
				<arg value="${fetch.portal.repository.url}" />
				<arg value="@{fetch.portal.remote.branch.name}:${fetch.portal.branch.name}" />
			</exec>
		</sequential>
	</macrodef>

	<macrodef name="fetch-subrepository">
		<attribute name="fetch.subrepository.dir" />
		<attribute name="fetch.subrepository.local.branch.name" />
		<attribute name="fetch.subrepository.name" />
		<attribute name="fetch.subrepository.remote.branch.name" />

		<sequential>
			<local name="fetch.subrepository.url" />

			<condition else="git@github.com:liferay/@{fetch.subrepository.name}.git" property="fetch.subrepository.url" value="git@github-dev.liferay.com:liferay/@{fetch.subrepository.name}.git">
				<isset property="env.JENKINS_HOME" />
			</condition>

			<local name="fetch.subrepository.branch.name" />

			<condition else="@{fetch.subrepository.remote.branch.name}" property="fetch.subrepository.branch.name" value="@{fetch.subrepository.local.branch.name}">
				<not>
					<equals arg1="${fetch.subrepository.local.branch.name}" arg2="" />
				</not>
			</condition>

			<echo>git -C @{fetch.subrepository.dir} fetch --force --no-tags ${fetch.subrepository.url} @{fetch.subrepository.remote.branch.name}:${fetch.subrepository.branch.name}</echo>

			<exec executable="git">
				<arg value="-C" />
				<arg value="@{fetch.subrepository.dir}" />
				<arg value="fetch" />
				<arg value="--force" />
				<arg value="--no-tags" />
				<arg value="${fetch.subrepository.url}" />
				<arg value="@{fetch.subrepository.remote.branch.name}:${fetch.subrepository.branch.name}" />
			</exec>
		</sequential>
	</macrodef>

	<macrodef name="prepare-profile-dxp-properties">
		<attribute name="from.branch.name" />
		<attribute name="to.branch.name" />

		<sequential>

			<!-- build.profile-dxp.properties -->

			<echo message="build.profile-dxp.properties" />

			<condition property="git.working.branch.name" value="${to.branch.name}">
				<not>
					<isset property="git.working.branch.name" />
				</not>
			</condition>

			<condition else="7z" property="snapshot.bundle.file.extension" value="zip">
				<equals arg1="${git.working.branch.name}" arg2="7.0.x" />
			</condition>

			<echo file="build.profile-dxp.properties">##
## Autogenerated
##

build.profile=dxp
build.repository.private.password=${build.repository.private.password}
build.repository.private.url=${build.repository.private.url}
build.repository.private.username=${build.repository.private.username}

git.working.branch.name=${git.working.branch.name}

snapshot.bundle.base.url=${snapshot.bundle.base.url}
snapshot.bundle.url=${snapshot.bundle.base.url}snapshot-${git.working.branch.name}-private/latest/liferay-portal-tomcat-${git.working.branch.name}-private.${snapshot.bundle.file.extension}</echo>

			<!-- release.profile-dxp.properties -->

			<echo message="release.profile-dxp.properties" />

			<echo file="release.profile-dxp.properties">##
## Autogenerated
##

lp.version=${lp.version[@{to.branch.name}]}

release.info.build=${release.info.build[@{to.branch.name}]}
release.info.date=${release.info.date[@{to.branch.name}]}
release.info.name=${release.info.name[@{to.branch.name}]}
release.info.version=${release.info.version[@{to.branch.name}]}
release.info.version.display.name=${release.info.version.display.name[@{to.branch.name}]}</echo>

			<!-- sql/sql.profile-dxp.properties -->

			<echo message="sql/sql.profile-dxp.properties" />

			<echo file="sql/sql.profile-dxp.properties">##
## Autogenerated
##

database.types=${database.types[@{to.branch.name}]}</echo>

			<!-- test.profile-dxp.properties -->

			<echo message="test.profile-dxp.properties" />

			<echo file="test.profile-dxp.properties">##
## Autogenerated
##

liferay.portal.branch=${liferay.portal.branch[@{to.branch.name}]}

test.run.environment=${test.run.environment[@{to.branch.name}]}

testray.build.type=${testray.build.type[@{to.branch.name}]}</echo>

			<!-- sql/portal-data-release.sql -->

			<local name="replace.portal.data.release.sql" />

			<condition property="replace.portal.data.release.sql">
				<available file="sql/portal-data-release.sql" />
			</condition>

			<echo if:set="replace.portal.data.release.sql" message="sql/portal-data-release.sql" />

			<replaceregexp
				file="sql/portal-data-release.sql"
				if:set="replace.portal.data.release.sql"
				match="${portal.data.release[@{from.branch.name}]}"
				replace="${portal.data.release[@{to.branch.name}]}"
			/>
		</sequential>
	</macrodef>

	<macrodef name="prepare-working-dir-private">
		<sequential>
			<loadproperties srcFile="working.dir.properties">
				<filterchain>
					<linecontains>
						<contains value="to.branch.name" />
					</linecontains>
				</filterchain>
			</loadproperties>

			<loadproperties srcFile="working.dir.properties">
				<filterchain>
					<tokenfilter>
						<containsregex pattern="(build\.repository\.private\.\w+)\Q[${to.branch.name}]\E" replace="\1" />
					</tokenfilter>
				</filterchain>
			</loadproperties>

			<delete file="working.dir.properties" />

			<propertyfile file="build.${user.name}.properties">
				<entry key="build.repository.private.password" value="${build.repository.private.password}" />
				<entry key="build.repository.private.url" value="${build.repository.private.url}" />
				<entry key="build.repository.private.username" value="${build.repository.private.username}" />
			</propertyfile>
		</sequential>
	</macrodef>

	<target name="checkout-portal" unless="prepare.working.dir.private">
		<loadfile
			property="portal.git.commit"
			srcFile="git-commit-portal"
		>
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadfile>

		<local name="return.code" />

		<exec executable="git" failonerror="false" resultproperty="return.code">
			<arg value="log" />
			<arg value="-n" />
			<arg value="1" />
			<arg value="${portal.git.commit}" />
		</exec>

		<condition property="portal.git.commit.available">
			<equals arg1="${return.code}" arg2="0" />
		</condition>

		<fetch-portal
			fetch.portal.local.branch.name="${public.branch.name}"
			fetch.portal.remote.branch.name="${public.branch.name}"
			fetch.portal.repository.name="liferay-portal-ee"
			unless:set="portal.git.commit.available"
		/>

		<local name="return.code" />

		<exec executable="git" failonerror="false" resultproperty="return.code">
			<arg value="tag" />
			<arg value="--force" />
			<arg value="git-commit-portal" />
			<arg value="${portal.git.commit}" />
		</exec>

		<fail message="Please fetch the public branch from upstream before using this command.">
			<condition>
				<not>
					<equals arg1="${return.code}" arg2="0" />
				</not>
			</condition>
		</fail>

		<loadresource property="working.dir.checkout.excludes.git">
			<propertyresource name="working.dir.checkout.excludes" />
			<filterchain>
				<replacestring from="," to=" :(exclude)" />
			</filterchain>
		</loadresource>

		<exec executable="git" failonerror="true">
			<arg value="checkout" />
			<arg value="refs/tags/git-commit-portal" />
			<arg value="." />
			<arg line=":(exclude)${working.dir.checkout.excludes.git}" />
		</exec>

		<exec executable="git">
			<arg value="reset" />
			<arg value="HEAD" />
			<arg value="." />
		</exec>

		<exec executable="git">
			<arg value="tag" />
			<arg value="--delete" />
			<arg value="git-commit-portal" />
		</exec>
	</target>

	<target if="prepare.working.dir.private" name="checkout-portal-private">
		<loadfile
			property="portal.private.git.commit"
			srcFile="git-commit-portal-private"
		>
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadfile>

		<exec executable="git" resultproperty="portal.private.git.commit.result">
			<arg value="cat-file" />
			<arg value="-e" />
			<arg value="${portal.private.git.commit}" />
		</exec>

		<fail message="Please run this command from the liferay-portal-ee repository.">
			<condition>
				<not>
					<equals arg1="${portal.private.git.commit.result}" arg2="0" />
				</not>
			</condition>
		</fail>

		<local name="return.code" />

		<exec executable="git" failonerror="false" resultproperty="return.code">
			<arg value="log" />
			<arg value="-n" />
			<arg value="1" />
			<arg value="${portal.private.git.commit}" />
		</exec>

		<condition property="portal.private.git.commit.available">
			<equals arg1="${return.code}" arg2="0" />
		</condition>

		<fetch-portal
			fetch.portal.local.branch.name="${private.branch.name}"
			fetch.portal.remote.branch.name="${private.branch.name}"
			fetch.portal.repository.name="liferay-portal-ee"
			unless:set="portal.private.git.commit.available"
		/>

		<local name="return.code" />

		<exec executable="git" failonerror="false" resultproperty="return.code">
			<arg value="tag" />
			<arg value="--force" />
			<arg value="git-commit-portal-private" />
			<arg value="${portal.private.git.commit}" />
		</exec>

		<fail message="Please fetch the private branch from upstream before using this command.">
			<condition>
				<not>
					<equals arg1="${return.code}" arg2="0" />
				</not>
			</condition>
		</fail>

		<exec executable="git" failonerror="true">
			<arg value="checkout" />
			<arg value="refs/tags/git-commit-portal-private" />
			<arg if:true="${checkout.portal.private.releng}" value="modules/.releng/private" />
			<arg value="modules/private" />
			<arg value="working.dir.properties" />
		</exec>

		<exec executable="git">
			<arg value="reset" />
			<arg value="HEAD" />
			<arg if:true="${checkout.portal.private.releng}" value="modules/.releng/private" />
			<arg value="modules/private" />
			<arg value="working.dir.properties" />
		</exec>

		<exec executable="git">
			<arg value="tag" />
			<arg value="--delete" />
			<arg value="git-commit-portal-private" />
		</exec>
	</target>

	<target if="working.dir.checkout.dxp.apps.project.names" name="checkout-private-projects">
		<script language="javascript">
			<![CDATA[
				var workingDirCheckoutDXPAppsProjectNames = project.getProperty("working.dir.checkout.dxp.apps.project.names");

				var projectNames = workingDirCheckoutDXPAppsProjectNames.split(",");

				for (i = 0; i < projectNames.length; i++) {
					var task = project.createTask("checkout-dxp-apps");

					task.setDynamicAttribute("checkout.dxp.apps.branch", project.getProperty("working.dir.checkout.dxp.apps." + projectNames[i] + ".branch"));
					task.setDynamicAttribute("checkout.dxp.apps.dirs", project.getProperty("working.dir.checkout.dxp.apps." + projectNames[i] + ".dirs"));
					task.setDynamicAttribute("checkout.dxp.apps.sha", project.getProperty("working.dir.checkout.dxp.apps." + projectNames[i] + ".sha"));
					task.setDynamicAttribute("checkout.dxp.branch.name", project.getProperty("private.branch.name"));

					task.perform();
				}
			]]>
		</script>
	</target>

	<target if="working.dir.checkout.subrepository.names" name="checkout-subrepositories">
		<script language="javascript">
			<![CDATA[
				var workingDirCheckoutSubrepositoryNames = project.getProperty("working.dir.checkout.subrepository.names");

				var subrepositoryNames = workingDirCheckoutSubrepositoryNames.split(",");

				for (i = 0; i < subrepositoryNames.length; i++) {
					var task = project.createTask("checkout-subrepository");

					task.setDynamicAttribute("checkout.subrepository.branch", project.getProperty("working.dir.checkout.subrepository." + subrepositoryNames[i] + ".branch"));
					task.setDynamicAttribute("checkout.subrepository.destination", project.getProperty("working.dir.checkout.subrepository." + subrepositoryNames[i] + ".destination"));
					task.setDynamicAttribute("checkout.subrepository.dir", project.getProperty("working.dir.checkout.subrepository." + subrepositoryNames[i] + ".dir"));
					task.setDynamicAttribute("checkout.subrepository.name", project.getProperty("working.dir.checkout.subrepository." + subrepositoryNames[i] + ".name"));
					task.setDynamicAttribute("checkout.subrepository.sha", project.getProperty("working.dir.checkout.subrepository." + subrepositoryNames[i] + ".sha"));

					task.perform();
				}
			]]>
		</script>
	</target>

	<target name="prepare-profile-dxp-properties">
		<property name="from.branch.name" value="${public.branch.name}" />
		<property name="to.branch.name" value="${private.branch.name}" />

		<prepare-profile-dxp-properties
			from.branch.name="${from.branch.name}"
			to.branch.name="${to.branch.name}"
		/>
	</target>

	<target depends="checkout-portal,checkout-portal-private,checkout-private-projects,checkout-subrepositories" name="prepare-working-dir">
		<property name="from.branch.name" value="${public.branch.name}" />
		<property name="to.branch.name" value="${private.branch.name}" />

		<prepare-profile-dxp-properties
			from.branch.name="${from.branch.name}"
			to.branch.name="${to.branch.name}"
			unless:true="${prepare.working.dir.private}"
		/>

		<prepare-working-dir-private
			if:true="${prepare.working.dir.private}"
		/>
	</target>
</project>